<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Calculating VaR and ES – Risk Management and Financial Institutions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./week_05.html" rel="next">
<link href="./week_03.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week_04.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Calculating VaR and ES</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Risk Management and Financial Institutions</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to Risk Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Revision of Basic Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Understanding VaR and ES</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Calculating VaR and ES</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Model Risk and Implementation Reality</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Future of Risk Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">week_07.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">week_08.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">week_09.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">week_10.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">week_11.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">week_12.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">week_13.html</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#parametric-approaches" id="toc-parametric-approaches" class="nav-link active" data-scroll-target="#parametric-approaches"><span class="header-section-number">4.1</span> Parametric Approaches</a>
  <ul class="collapse">
  <li><a href="#the-normal-distribution-assumption" id="toc-the-normal-distribution-assumption" class="nav-link" data-scroll-target="#the-normal-distribution-assumption"><span class="header-section-number">4.1.1</span> The Normal Distribution Assumption</a></li>
  <li><a href="#time-scaling-the-square-root-rule" id="toc-time-scaling-the-square-root-rule" class="nav-link" data-scroll-target="#time-scaling-the-square-root-rule"><span class="header-section-number">4.1.2</span> Time Scaling: The Square-Root Rule</a></li>
  <li><a href="#beyond-normality-lognormal-fat-tails-evt" id="toc-beyond-normality-lognormal-fat-tails-evt" class="nav-link" data-scroll-target="#beyond-normality-lognormal-fat-tails-evt"><span class="header-section-number">4.1.3</span> Beyond Normality: Lognormal, Fat Tails, EVT</a></li>
  <li><a href="#estimation-uncertainty-standard-errors-and-confidence-intervals" id="toc-estimation-uncertainty-standard-errors-and-confidence-intervals" class="nav-link" data-scroll-target="#estimation-uncertainty-standard-errors-and-confidence-intervals"><span class="header-section-number">4.1.4</span> Estimation Uncertainty: Standard Errors and Confidence Intervals</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">4.1.5</span> Key Takeaways</a></li>
  </ul></li>
  <li><a href="#historical-simulation-methods" id="toc-historical-simulation-methods" class="nav-link" data-scroll-target="#historical-simulation-methods"><span class="header-section-number">4.2</span> Historical Simulation Methods</a>
  <ul class="collapse">
  <li><a href="#basic-historical-simulation" id="toc-basic-historical-simulation" class="nav-link" data-scroll-target="#basic-historical-simulation"><span class="header-section-number">4.2.1</span> Basic Historical Simulation</a></li>
  <li><a href="#the-bootstrap-revolution" id="toc-the-bootstrap-revolution" class="nav-link" data-scroll-target="#the-bootstrap-revolution"><span class="header-section-number">4.2.2</span> The Bootstrap Revolution</a></li>
  <li><a href="#advanced-historical-simulation-methods" id="toc-advanced-historical-simulation-methods" class="nav-link" data-scroll-target="#advanced-historical-simulation-methods"><span class="header-section-number">4.2.3</span> Advanced Historical Simulation Methods</a></li>
  <li><a href="#choosing-the-right-approach" id="toc-choosing-the-right-approach" class="nav-link" data-scroll-target="#choosing-the-right-approach"><span class="header-section-number">4.2.4</span> Choosing the Right Approach</a></li>
  <li><a href="#key-takeaways-1" id="toc-key-takeaways-1" class="nav-link" data-scroll-target="#key-takeaways-1"><span class="header-section-number">4.2.5</span> Key Takeaways</a></li>
  </ul></li>
  <li><a href="#backtesting-and-model-validation" id="toc-backtesting-and-model-validation" class="nav-link" data-scroll-target="#backtesting-and-model-validation"><span class="header-section-number">4.3</span> Backtesting and Model Validation</a>
  <ul class="collapse">
  <li><a href="#the-backtesting-framework" id="toc-the-backtesting-framework" class="nav-link" data-scroll-target="#the-backtesting-framework"><span class="header-section-number">4.3.1</span> The Backtesting Framework</a></li>
  <li><a href="#the-basel-traffic-light-system" id="toc-the-basel-traffic-light-system" class="nav-link" data-scroll-target="#the-basel-traffic-light-system"><span class="header-section-number">4.3.2</span> The Basel Traffic Light System</a></li>
  <li><a href="#backtesting-expected-shortfall" id="toc-backtesting-expected-shortfall" class="nav-link" data-scroll-target="#backtesting-expected-shortfall"><span class="header-section-number">4.3.3</span> Backtesting Expected Shortfall</a></li>
  <li><a href="#key-takeaways-2" id="toc-key-takeaways-2" class="nav-link" data-scroll-target="#key-takeaways-2"><span class="header-section-number">4.3.4</span> Key Takeaways</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">4.4</span> References</a></li>
  <li><a href="#practice-questions-and-problems" id="toc-practice-questions-and-problems" class="nav-link" data-scroll-target="#practice-questions-and-problems"><span class="header-section-number">4.5</span> Practice Questions and Problems</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Calculating VaR and ES</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled" title="References">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
References
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Hull, J. C. 2023. Risk Management and Financial Institutions. Wiley Finance.
<ul>
<li>Chapter 11 - Value at Risk and Expected Shortfall</li>
<li>Chapter 12 - Historical Simulation and Extreme Value Theory</li>
<li>Chapter 13 - Model-Building Approach</li>
</ul></li>
<li>Pirie, W. L., and M. P. Kritzman. 2017. Derivatives. CFA Institute Investment Series. - Chapter 6 - Risk Management</li>
</ul>
</div>
</div>
<p><strong>Learning Outcomes:</strong></p>
<ul>
<li>Calculate VaR using parametric, historical simulation, and Monte Carlo methods</li>
<li>Apply Expected Shortfall calculations and understand their advantages over VaR</li>
<li>Implement variance reduction techniques to improve computational efficiency</li>
<li>Conduct rigorous backtesting using Kupiec, Christoffersen, and other statistical tests</li>
<li>Select appropriate calculation methods based on portfolio characteristics and constraints</li>
<li>Identify strengths and weaknesses of each approach in different market conditions</li>
</ul>
<section id="parametric-approaches" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="parametric-approaches"><span class="header-section-number">4.1</span> Parametric Approaches</h2>
<section id="the-normal-distribution-assumption" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="the-normal-distribution-assumption"><span class="header-section-number">4.1.1</span> The Normal Distribution Assumption</h3>
<p>Parametric approaches to risk measurement begin with a crucial assumption: we know (or can reasonably approximate) the probability distribution of our portfolio returns. The normal distribution serves as the natural starting point - not because markets are actually normal, but because it provides closed-form solutions and intuitive results. Like Newtonian physics in a relativistic world, the normal assumption works well enough in many situations to be useful, while being simple enough to implement in real-time.</p>
<p><strong>Key Advantages of Parametric Methods:</strong></p>
<ul>
<li>Closed-form solutions (instant calculations)</li>
<li>Smooth risk estimates (no jagged histograms)</li>
<li>Can extrapolate beyond available data</li>
<li>Standard statistical theory applies</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="VaR Formula with Normal Distribution">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
VaR Formula with Normal Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Core Assumption:</strong> Portfolio returns follow Normal distribution: <span class="math inline">\(R \sim N(\mu, \sigma^2)\)</span></li>
<li><strong>One-period VaR</strong> at confidence level <span class="math inline">\(\alpha\)</span> (e.g., 95%):</li>
</ul>
<p><span class="math display">\[\text{VaR}_\alpha = -\mu + \sigma \cdot z_\alpha\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\mu\)</span> = Expected return per period (often <span class="math inline">\(\approx\)</span> 0 for daily)</li>
<li><span class="math inline">\(\sigma\)</span> = Standard deviation of returns per period</li>
<li><span class="math inline">\(z_\alpha\)</span> = Positive quantile value (e.g., <span class="math inline">\(z_{0.95} = 1.645\)</span>, <span class="math inline">\(z_{0.99} = 2.326\)</span>)</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="ES Formula with Normal Distribution">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ES Formula with Normal Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Expected Shortfall</strong> = Average loss when loss exceeds VaR</li>
<li><strong>One-period ES</strong> at confidence level <span class="math inline">\(\alpha\)</span>:</li>
</ul>
<p><span class="math display">\[\text{ES}_\alpha = -\mu + \sigma \cdot \frac{\phi(z_\alpha)}{1-\alpha}\]</span> <span class="math display">\[\phi(z) = \frac{1}{\sqrt{2\pi}} e^{-(z^2/2)}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\phi(z)\)</span> = Standard normal PDF function</li>
<li><span class="math inline">\(z_\alpha\)</span> = Same quantile as in VaR (e.g., 1.645 for 95%)</li>
<li><span class="math inline">\((1-\alpha)\)</span> = Tail probability (e.g., 0.05 for 95% confidence)</li>
</ul>
<p><strong>Key Property:</strong> For normal distribution, ES/VaR ratio is constant:</p>
<ul>
<li>At 95% confidence: ES ≈ 1.25 × VaR</li>
<li>At 99% confidence: ES ≈ 1.14 × VaR</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Example: Basic Normal VaR and ES Calculation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Basic Normal VaR and ES Calculation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Portfolio: $100 million</li>
<li>Daily returns: <span class="math inline">\(\mu = 0.05\%\)</span>, <span class="math inline">\(\sigma = 2\%\)</span></li>
<li>Calculate 95% and 99% one-day VaR and ES</li>
</ul>
<p><strong>VaR Calculations:</strong></p>
<p><span class="math display">\[\text{VaR}_{95\%} = \$100M \times (-0.0005 + 0.02 \times 1.645) = \$3.24M\]</span></p>
<p><span class="math display">\[\text{VaR}_{99\%} = \$100M \times (-0.0005 + 0.02 \times 2.326) = \$4.60M\]</span></p>
<p><em>Interpretation</em>: “We are 95% confident we won’t lose more than $3.24M tomorrow”</p>
<p><strong>ES Calculations:</strong></p>
<p><span class="math display">\[\text{ES}_{95\%} = \$100M \times (-0.0005 + 0.02 \times 2.062) = \$4.07M\]</span></p>
<p><span class="math display">\[\text{ES}_{99\%} = \$100M \times (-0.0005 + 0.02 \times 2.67) = \$5.29M\]</span></p>
<p><em>Interpretation</em>: “In the 5% (1%) worst case scenarios, the average daily loss is $4.07M ($5.29) times the VaR”</p>
</div>
</div>
</section>
<section id="time-scaling-the-square-root-rule" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="time-scaling-the-square-root-rule"><span class="header-section-number">4.1.2</span> Time Scaling: The Square-Root Rule</h3>
<p>The square-root scaling rule is ubiquitous in risk management, but its validity depends on strong assumptions that often break down precisely when we need them most. Under normal distribution, both VaR and ES are linear functions of volatility <span class="math inline">\(\sigma\)</span>. Since volatility scales with <span class="math inline">\(\sqrt{h}\)</span>, both risk measures inherit this scaling.</p>
<p><span class="math display">\[\text{VaR}_{h\text{-day}} = \text{VaR}_{1\text{-day}} \times \sqrt{h}\]</span></p>
<p><span class="math display">\[\text{ES}_{h\text{-day}} = \text{ES}_{1\text{-day}} \times \sqrt{h}\]</span></p>
<p><strong>Required Assumptions:</strong></p>
<ul>
<li>Returns are independent across time (no autocorrelation)</li>
<li>Returns are identically distributed (no volatility clustering)</li>
<li>No mean reversion or momentum</li>
<li>Normal distribution maintained across horizons</li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 59%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">When It Works</th>
<th style="text-align: center;">When It Fails</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Liquid markets</td>
<td style="text-align: center;">Crisis periods (correlations spike)</td>
</tr>
<tr class="even">
<td style="text-align: center;">Short horizons (&lt; 10 days)</td>
<td style="text-align: center;">Illiquid assets (autocorrelation)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Normal market conditions</td>
<td style="text-align: center;">Long horizons (mean reversion kicks in)</td>
</tr>
<tr class="even">
<td style="text-align: center;">Well-diversified portfolios</td>
<td style="text-align: center;">Concentrated positions (jump risk)</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Critical Warning for ES:</strong> ES scaling is even more fragile than VaR scaling.</li>
</ul>
<p><strong>Basel/Regulatory Approach:</strong></p>
<ul>
<li>FRTB uses different liquidity horizons (10-120 days) rather than naive scaling</li>
<li>Recognizes that scaling assumptions fail for longer horizons</li>
<li>ES scaling particularly scrutinized for illiquid assets</li>
</ul>
<p><strong>Key Observations:</strong></p>
<ol type="1">
<li><p><strong>Normal vs Lognormal</strong>: Nearly identical for daily horizons</p>
<ul>
<li>Lognormal prevents returns &lt; -100% (realistic constraint)</li>
<li>Differences only matter for longer horizons or high volatility</li>
</ul></li>
<li><p><strong>Fat Tails Impact</strong>: Student-t dramatically increases tail risk</p>
<ul>
<li>99% VaR doubles (Normal: $4.65M → Student-t(4): $9.20M)</li>
<li>ES/VaR ratio increases (1.25 → 1.62 → 2.01)</li>
<li>Lower ν = fatter tails = higher risk</li>
</ul></li>
<li><p><strong>Practical Implications</strong>:</p>
<ul>
<li>Normal: Underestimates extreme risk by 2-3×</li>
<li>Lognormal: Minor adjustment, mainly theoretical</li>
<li>Student-t: Essential for crisis-aware risk management</li>
</ul></li>
</ol>
<p>:::{.callout-important} <strong>Critical Insight:</strong> The ES/VaR ratio reveals tail behavior</p>
<ul>
<li>Normal: 1.25 (thin tails)</li>
<li>Student-t(3): 2.01 (fat tails)</li>
</ul>
<p>This ratio is a quick “health check” for your distribution assumption! :::</p>
<p><strong>Which to Use?</strong></p>
<ul>
<li><strong>Normal</strong>: Quick calculations, well-diversified portfolios</li>
<li><strong>Lognormal</strong>: Equity portfolios, longer horizons</li>
<li><strong>Student-t</strong>: Crisis risk, regulatory stress testing, concentrated portfolios</li>
</ul>
</section>
<section id="beyond-normality-lognormal-fat-tails-evt" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="beyond-normality-lognormal-fat-tails-evt"><span class="header-section-number">4.1.3</span> Beyond Normality: Lognormal, Fat Tails, EVT</h3>
<p>Real financial returns exhibit features that the normal distribution cannot capture: they’re skewed, have fat tails, and show volatility clustering. Moving beyond normality is essential for accurate risk measurement.</p>
<p><strong>Lognormal Distribution:</strong> Appropriate when returns can’t go below -100% (realistic for stocks)</p>
<p><span class="math display">\[\text{VaR}_\alpha^{\text{log}} = 1 - e^{\mu - \sigma \cdot z_\alpha}\]</span></p>
<p><strong>Student-t Distribution (Fat Tails):</strong> Captures extreme events better than normal</p>
<p><span class="math display">\[\text{VaR}_\alpha^t = \mu + \sigma \cdot \sqrt{\frac{\nu-2}{\nu}} \cdot t_{\nu,\alpha}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\nu\)</span> = Degrees of freedom (lower = fatter tails)</li>
<li><span class="math inline">\(t_{\nu,\alpha}\)</span> = Student-t quantile</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Key Insight:</strong> As tails get fatter, VaR increases dramatically</p>
</div>
</div>
<p>When normal assumptions break spectacularly (think 2008), we need tools designed specifically for extreme events. <strong>Extreme Value Theory (EVT)</strong> provides a mathematical framework for the impossible becoming possible.</p>
<p><strong>The EVT Philosophy:</strong></p>
<ul>
<li>Don’t model the entire distribution</li>
<li>Focus only on the tail behavior</li>
<li>Let the extremes speak for themselves</li>
<li>Two Main Approaches: Block Maxima (GEV Distribution), Peaks Over Threshold (GPD)</li>
</ul>
<p><strong>When to Use EVT:</strong></p>
<ul>
<li>Extreme risk assessment (99.9%+ VaR)</li>
<li>Stress testing</li>
<li>Regulatory capital (Basel III)</li>
<li>Insurance/catastrophe modeling</li>
</ul>
</section>
<section id="estimation-uncertainty-standard-errors-and-confidence-intervals" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="estimation-uncertainty-standard-errors-and-confidence-intervals"><span class="header-section-number">4.1.4</span> Estimation Uncertainty: Standard Errors and Confidence Intervals</h3>
<p>Risk measures are estimates, not certainties. Understanding their precision is as important as calculating the point estimate itself. For normal VaR estimated from historical data, we can calculate <strong>Standard Error of VaR Estimate</strong> and <strong>Confidence Interval</strong>:</p>
<p><span class="math display">\[SE(\widehat{\text{VaR}}_\alpha) \approx \frac{\sigma}{\sqrt{2n}} \sqrt{1 + \frac{z_\alpha^2}{2}}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(SE\)</span> = Standard error (uncertainty of our VaR estimate)</li>
<li><span class="math inline">\(\sigma\)</span> = Standard deviation of returns</li>
<li><span class="math inline">\(n\)</span> = Number of observations in sample</li>
<li><span class="math inline">\(z_\alpha\)</span> = Normal quantile at confidence level <span class="math inline">\(\alpha\)</span> (e.g., 1.645 for 95%)</li>
</ul>
<p><span class="math display">\[CI = \widehat{\text{VaR}}_\alpha \pm z_{CI} \times SE(\widehat{\text{VaR}}_\alpha)\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(CI\)</span> = Confidence interval for the true VaR value</li>
<li><span class="math inline">\(\widehat{\text{VaR}}_\alpha\)</span> = Our estimated VaR value</li>
<li><span class="math inline">\(z_{CI}\)</span> = Z-score for desired confidence interval (e.g., 1.645 for 90%, 1.96 for 95%)</li>
<li><span class="math inline">\(SE(\widehat{\text{VaR}}_\alpha)\)</span> = Standard error of the VaR estimate</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Example: Uncertainty in VaR Estimates">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Uncertainty in VaR Estimates
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Data: 1000 daily returns</li>
<li>Sample <span class="math inline">\(\sigma = 2\%\)</span></li>
<li>95% VaR estimate = $100M <span class="math inline">\(\times\)</span> 0.02 <span class="math inline">\(\times\)</span> 1.645 = $3.29M</li>
</ul>
<p><strong>Standard error:</strong></p>
<p><span class="math display">\[SE = \frac{0.02}{\sqrt{2000}} \times \sqrt{1 + \frac{1.645^2}{2}} = 0.00061\]</span></p>
<p>SE in dollars = $100M <span class="math inline">\(\times\)</span> 0.00061 = $61,000</p>
<p><strong>90% CI for VaR:</strong></p>
<p><span class="math display">\[CI = \$3.29M \pm 1.645 \times \$0.061M = [\$3.19M, \$3.39M]\]</span></p>
<p><em>Implication</em>: Our “precise” $3.29M VaR has <span class="math inline">\(\pm 3\%\)</span> uncertainty!</p>
</div>
</div>
<p><strong>Factors Affecting Precision:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Factor</th>
<th style="text-align: center;">Effect on Precision</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Sample size</strong></td>
<td style="text-align: center;">Doubles <span class="math inline">\(n\)</span> → Reduces SE by <span class="math inline">\(\sqrt{2}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Confidence level</strong></td>
<td style="text-align: center;">99% VaR → 50% larger SE than 95% VaR</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Distribution</strong></td>
<td style="text-align: center;">Fat tails → 2-3<span class="math inline">\(\times\)</span> larger SE</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>ES vs VaR</strong></td>
<td style="text-align: center;">ES standard error <span class="math inline">\(\approx\)</span> 2<span class="math inline">\(\times\)</span> VaR standard error</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Key Message:</strong> Every risk measure is an estimate with uncertainty. Ignoring this uncertainty is itself a major source of risk.</p>
</div>
</div>
</section>
<section id="key-takeaways" class="level3" data-number="4.1.5">
<h3 data-number="4.1.5" class="anchored" data-anchor-id="key-takeaways"><span class="header-section-number">4.1.5</span> Key Takeaways</h3>
<p><strong>Parametric Methods Summary:</strong></p>
<ul>
<li><strong>Normal provides baseline:</strong> Quick, simple, often adequate</li>
<li><strong>Time scaling needs caution:</strong> Square-root rule fails in crisis</li>
<li><strong>Fat tails matter:</strong> Student-t or EVT for realistic extremes</li>
<li><strong>Uncertainty is real:</strong> Always estimate confidence intervals</li>
</ul>
<p><strong>Decision Framework:</strong></p>
<ul>
<li>Daily trading limits → Normal often sufficient</li>
<li>Risk capital → Fat-tailed distributions essential</li>
<li>Extreme scenarios → EVT methodology required</li>
<li>All cases → Quantify estimation uncertainty</li>
</ul>
</section>
</section>
<section id="historical-simulation-methods" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="historical-simulation-methods"><span class="header-section-number">4.2</span> Historical Simulation Methods</h2>
<section id="basic-historical-simulation" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="basic-historical-simulation"><span class="header-section-number">4.2.1</span> Basic Historical Simulation</h3>
<p>Historical Simulation represents the philosophical opposite of parametric methods: instead of assuming we know the distribution, we let the data tell its own story. This approach, pioneered by major banks in the 1990s, remains the most widely used VaR methodology in practice. Its appeal lies in a simple premise - the best predictor of tomorrow’s risk is yesterday’s experience.</p>
<p><strong>Core Philosophy:</strong> “The future will be sufficiently like the recent past that historical data can forecast risk”</p>
<p><strong>The Basic HS Algorithm:</strong></p>
<ol type="1">
<li>Collect historical returns (typically 250-500 days)</li>
<li>Apply today’s portfolio weights to historical returns</li>
<li>Generate hypothetical P&amp;L distribution</li>
<li>Read VaR/ES directly from empirical distribution</li>
</ol>
<p><strong>Mathematical Formulation:</strong></p>
<p>For <span class="math inline">\(n\)</span> historical observations ordered from worst to best:</p>
<p><span class="math display">\[\text{VaR}_\alpha^{HS} = -L_{[\alpha \cdot n]}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(L_{[k]}\)</span> = The k-th order statistic (k-th worst return in sorted data)</li>
<li><span class="math inline">\([\alpha \cdot n]\)</span> = Index position, rounded (e.g., [0.05 × 1000] = 50th worst)</li>
<li><span class="math inline">\(n\)</span> = Total number of historical observations</li>
</ul>
<p><span class="math display">\[\text{ES}_\alpha^{HS} = -\frac{1}{m} \sum_{i=1}^{m} L_{[i]}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(m = [(1-\alpha) \times n]\)</span> = Number of observations in the tail</li>
<li><span class="math inline">\(L_{[i]}\)</span> = The i-th worst return (sorted from worst to best)</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Example: Basic Historical Simulation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Basic Historical Simulation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider a 500-day time window of daily returns for the SPY ETF to calculate the 1-day VaR and ES at a 99% confidence level. The table below lists the 10 worst daily returns from this period:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">No.</th>
<th style="text-align: center;">Date</th>
<th style="text-align: center;">Log Returns</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1.</td>
<td style="text-align: center;">2024-08-05</td>
<td style="text-align: center;">-0.029556</td>
</tr>
<tr class="even">
<td style="text-align: center;">2.</td>
<td style="text-align: center;">2022-11-02</td>
<td style="text-align: center;">-0.025416</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3.</td>
<td style="text-align: center;">2022-12-15</td>
<td style="text-align: center;">-0.024766</td>
</tr>
<tr class="even">
<td style="text-align: center;">4.</td>
<td style="text-align: center;">2024-07-24</td>
<td style="text-align: center;">-0.022923</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5.</td>
<td style="text-align: center;">2022-11-09</td>
<td style="text-align: center;">-0.020817</td>
</tr>
<tr class="even">
<td style="text-align: center;">6.</td>
<td style="text-align: center;">2024-09-03</td>
<td style="text-align: center;">-0.020794</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7.</td>
<td style="text-align: center;">2023-02-21</td>
<td style="text-align: center;">-0.020265</td>
</tr>
<tr class="even">
<td style="text-align: center;">8.</td>
<td style="text-align: center;">2024-08-02</td>
<td style="text-align: center;">-0.018794</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9.</td>
<td style="text-align: center;">2023-03-09</td>
<td style="text-align: center;">-0.018622</td>
</tr>
<tr class="even">
<td style="text-align: center;">10.</td>
<td style="text-align: center;">2022-12-05</td>
<td style="text-align: center;">-0.018153</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>1% of 500 observations equals 5</strong>, meaning the 5th worst loss represents the 1-day 99% VaR.</li>
<li><strong>VaR</strong>: The daily 99% VaR is the 5th worst return, which corresponds to -0.020817.</li>
<li><strong>ES</strong>: The daily 99% ES is the average of the 4 worst returns, -0.025665, providing an estimate of the average loss beyond the VaR threshold.</li>
</ul>
</div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 54%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><strong>Critical Advantages</strong></th>
<th style="text-align: center;"><strong>Critical Limitations</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">No distributional assumptions</td>
<td style="text-align: center;">Limited by available history</td>
</tr>
<tr class="even">
<td style="text-align: center;">Captures fat tails, skewness automatically</td>
<td style="text-align: center;">Cannot exceed worst historical loss</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Includes all complex dependencies</td>
<td style="text-align: center;">Assumes past = future</td>
</tr>
<tr class="even">
<td style="text-align: center;">Simple to explain to management</td>
<td style="text-align: center;">Poor for new products</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Handles derivatives naturally</td>
<td style="text-align: center;">“Fighting the last war” problem</td>
</tr>
</tbody>
</table>
</section>
<section id="the-bootstrap-revolution" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="the-bootstrap-revolution"><span class="header-section-number">4.2.2</span> The Bootstrap Revolution</h3>
<p>The bootstrap, introduced by Bradley Efron in 1979, transforms historical simulation from a simple empirical method into a sophisticated resampling framework. By treating our historical data as the “population” and resampling with replacement, we can generate thousands of alternative histories and better understand the uncertainty in our risk estimates.</p>
<p><strong>Bootstrap Historical Simulation Algorithm:</strong></p>
<ol type="1">
<li><strong>Original sample:</strong> <span class="math inline">\(\{r_1, r_2, ..., r_n\}\)</span></li>
<li><strong>Resample:</strong> Draw <span class="math inline">\(n\)</span> returns WITH replacement</li>
<li><strong>Calculate:</strong> VaR/ES for bootstrap sample</li>
<li><strong>Repeat:</strong> Generate B bootstrap samples (typically 1000+)</li>
<li><strong>Analyze:</strong> Distribution of risk measures</li>
</ol>
<p><strong>Why Bootstrap Works:</strong></p>
<ul>
<li>Creates new “possible histories”</li>
<li>Breaks temporal dependencies</li>
<li>Provides confidence intervals</li>
<li>Smooths empirical distribution</li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 28%">
<col style="width: 42%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Advanced Bootstrap Techniques</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">When to Use</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Block Bootstrap</strong></td>
<td style="text-align: center;">Resample blocks to preserve autocorrelation</td>
<td style="text-align: center;">Volatility clustering present</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Stationary Bootstrap</strong></td>
<td style="text-align: center;">Random block lengths</td>
<td style="text-align: center;">Unknown dependency structure</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Filtered Bootstrap</strong></td>
<td style="text-align: center;">Bootstrap residuals from GARCH</td>
<td style="text-align: center;">Time-varying volatility</td>
</tr>
</tbody>
</table>
</section>
<section id="advanced-historical-simulation-methods" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="advanced-historical-simulation-methods"><span class="header-section-number">4.2.3</span> Advanced Historical Simulation Methods</h3>
<p>Basic historical simulation treats all observations equally, but markets evolve. Several enhancements address this limitation:</p>
<p><strong>Age-Weighted HS (Exponential Weighting)</strong></p>
<p>Recent observations get higher weights: <span class="math display">\[w_i = \lambda^{i-1}(1-\lambda)\]</span></p>
<p>Where <span class="math inline">\(\lambda \approx 0.94-0.99\)</span> determines decay speed. Yesterday matters more than last year.</p>
<p><strong>Volatility-Weighted HS (Hull-White)</strong></p>
<p>Scale historical returns to current volatility: <span class="math display">\[r_i^{adjusted} = r_i \times \frac{\sigma_{current}}{\sigma_i}\]</span></p>
<p>This prevents calm-period returns from understating risk in volatile times (and vice versa).</p>
<p><strong>Filtered Historical Simulation (FHS)</strong></p>
<p>The most sophisticated approach:</p>
<ol type="1">
<li>Fit GARCH model to capture volatility dynamics</li>
<li>Extract standardized residuals (innovations)</li>
<li>Bootstrap these residuals (not raw returns)</li>
<li>Reconstruct returns using current volatility regime</li>
</ol>
<p><strong>Key Insight:</strong> FHS bootstraps the “shocks” while respecting today’s volatility level.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Method</th>
<th>Normal Market</th>
<th>Volatility Spike</th>
<th>Regime Change</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Basic HS</td>
<td>Good</td>
<td>Too slow</td>
<td>Fails</td>
</tr>
<tr class="even">
<td>Age-weighted</td>
<td>Good</td>
<td>Better</td>
<td>Slow</td>
</tr>
<tr class="odd">
<td>Vol-weighted</td>
<td>Good</td>
<td>Excellent</td>
<td>Good</td>
</tr>
<tr class="even">
<td>FHS</td>
<td>Excellent</td>
<td>Excellent</td>
<td>Excellent</td>
</tr>
</tbody>
</table>
</section>
<section id="choosing-the-right-approach" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="choosing-the-right-approach"><span class="header-section-number">4.2.4</span> Choosing the Right Approach</h3>
<p><strong>Implementation Tip:</strong> Start simple (basic HS), add complexity only if backtesting shows need for improvement. Perfect is the enemy of good enough in risk management.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 44%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Method</th>
<th style="text-align: center;">Best For</th>
<th style="text-align: center;">Key Advantage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Basic HS</strong></td>
<td style="text-align: center;">Regulatory reporting, stable markets</td>
<td style="text-align: center;">Simple, no assumptions</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Bootstrap HS</strong></td>
<td style="text-align: center;">Limited data, confidence intervals</td>
<td style="text-align: center;">More scenarios</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Weighted HS</strong></td>
<td style="text-align: center;">Regime shifts, recent stress</td>
<td style="text-align: center;">Responsive to change</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Filtered (FHS)</strong></td>
<td style="text-align: center;">Trading desks, volatile markets</td>
<td style="text-align: center;">Captures current volatility</td>
</tr>
</tbody>
</table>
<p><strong>Best Practice:</strong> Run multiple approaches in parallel</p>
<ul>
<li>Basic HS for regulatory reporting</li>
<li>FHS for internal risk management</li>
<li>Bootstrap for uncertainty assessment</li>
<li>Compare results for validation</li>
</ul>
<p><strong>Data Minimums:</strong></p>
<ul>
<li>250 observations (1 year) = bare minimum</li>
<li>500-1000 observations (2-4 years) = recommended</li>
<li>Must include at least one stress period</li>
</ul>
</section>
<section id="key-takeaways-1" class="level3" data-number="4.2.5">
<h3 data-number="4.2.5" class="anchored" data-anchor-id="key-takeaways-1"><span class="header-section-number">4.2.5</span> Key Takeaways</h3>
<p><strong>Historical Simulation Summary:</strong></p>
<ul>
<li><strong>Basic HS:</strong> Simple, robust, but backward-looking</li>
<li><strong>Bootstrap:</strong> Adds sophistication, provides confidence intervals</li>
<li><strong>Weighting:</strong> Makes HS adaptive to market conditions</li>
<li><strong>FHS:</strong> Optimal blend of parametric and non-parametric</li>
</ul>
<p><strong>The Fundamental Trade-off:</strong></p>
<ul>
<li>Simplicity vs.&nbsp;Sophistication</li>
<li>Stability vs.&nbsp;Responsiveness</li>
<li>Transparency vs.&nbsp;Accuracy</li>
</ul>
</section>
</section>
<section id="backtesting-and-model-validation" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="backtesting-and-model-validation"><span class="header-section-number">4.3</span> Backtesting and Model Validation</h2>
<section id="the-backtesting-framework" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="the-backtesting-framework"><span class="header-section-number">4.3.1</span> The Backtesting Framework</h3>
<p>Backtesting is where theory meets reality - the moment of truth for any risk model. As Alan Greenspan noted, “Disclosure of quantitative measures of market risk, such as value-at-risk, is enlightening only when accompanied by a thorough discussion of how the risk measures were calculated and how they related to actual performance.” Without rigorous backtesting, VaR is merely an expensive random number generator.</p>
<p><strong>Core Concept:</strong> Backtesting systematically compares predicted risk (VaR forecasts) with realized outcomes (actual P&amp;L) to validate model accuracy.</p>
<p><strong>The Fundamental Question:</strong> “Are we experiencing the number and magnitude of losses our model predicts?”</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Basic Framework">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Basic Framework
</div>
</div>
<div class="callout-body-container callout-body">
<p>For each day <span class="math inline">\(t\)</span>:</p>
<ol type="1">
<li>Calculate <span class="math inline">\(\text{VaR}_t\)</span> using data up to <span class="math inline">\(t-1\)</span></li>
<li>Observe actual loss <span class="math inline">\(L_t\)</span></li>
<li>Record violation indicator:</li>
</ol>
<p><span class="math display">\[
I_t = \begin{cases}
1 &amp; \text{if } L_t &gt; \text{VaR}_t \text{ (violation)} \\
0 &amp; \text{if } L_t \leq \text{VaR}_t \text{ (no violation)}
\end{cases}
\]</span></p>
<p><strong>Key Metrics:</strong></p>
<ul>
<li><strong>Violation Rate:</strong> <span class="math inline">\(\hat{p} = \frac{1}{T}\sum_{t=1}^T I_t\)</span></li>
<li><strong>Expected:</strong> <span class="math inline">\(p = 1 - \alpha\)</span> (e.g., 5% for 95% VaR)</li>
<li><strong>Test:</strong> Is <span class="math inline">\(\hat{p}\)</span> significantly different from <span class="math inline">\(p\)</span>?</li>
</ul>
</div>
</div>
<p>Testing whether observed violations are statistically significant requires careful consideration of both Type I errors (rejecting a correct model) and Type II errors (accepting an incorrect model).</p>
<section id="kupiecs-unconditional-coverage-test-1995" class="level4">
<h4 class="anchored" data-anchor-id="kupiecs-unconditional-coverage-test-1995">Kupiec’s Unconditional Coverage Test (1995)</h4>
<p>Tests if violation frequency matches expected level:</p>
<p><span class="math display">\[LR_{uc} = -2\ln\left[\frac{p^n(1-p)^{T-n}}{\hat{p}^n(1-\hat{p})^{T-n}}\right] \sim \chi^2(1)\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(n\)</span> = Number of violations observed</li>
<li><span class="math inline">\(T\)</span> = Total observations</li>
<li><span class="math inline">\(p\)</span> = Expected violation rate</li>
<li><span class="math inline">\(\hat{p} = n/T\)</span> = Observed violation rate</li>
</ul>
<p><strong>Decision Rule:</strong> Reject if <span class="math inline">\(LR_{uc} &gt; 3.841\)</span> (95% confidence)</p>
<div class="callout callout-style-default callout-note callout-titled" title="Example: Kupiec Test">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Kupiec Test
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Bank’s 99% VaR over 250 trading days</li>
<li>Violations observed: 8</li>
<li>Expected violations: 250 <span class="math inline">\(\times\)</span> 1% = 2.5</li>
<li>Expected rate <span class="math inline">\(p = 0.01\)</span></li>
<li>Observed rate <span class="math inline">\(\hat{p} = 8/250 = 0.032\)</span></li>
</ul>
<p><span class="math display">\[LR_{uc} = -2\ln\left[\frac{(0.01)^8(0.99)^{242}}{(0.032)^8(0.968)^{242}}\right] = -2 \times (-7.53) = 15.06\]</span></p>
<p><strong>Decision:</strong> Since <span class="math inline">\(15.06 &gt; 3.841\)</span>, reject the model!</p>
</div>
</div>
</section>
<section id="christoffersens-conditional-coverage-test-1998" class="level4">
<h4 class="anchored" data-anchor-id="christoffersens-conditional-coverage-test-1998">Christoffersen’s Conditional Coverage Test (1998)</h4>
<p>Tests both frequency AND independence of violations:</p>
<p><span class="math display">\[LR_{cc} = LR_{uc} + LR_{ind} \sim \chi^2(2)\]</span></p>
<p>The independence test checks for violation clustering:</p>
<p><span class="math display">\[LR_{ind} = -2\ln\left[\frac{(1-p)^{n_{00}+n_{10}} \cdot p^{n_{01}+n_{11}}}{(1-p_0)^{n_{00}} \cdot p_0^{n_{01}} \cdot (1-p_1)^{n_{10}} \cdot p_1^{n_{11}}}\right]\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(p\)</span> = overall violation probability (should be 0.05 for 95% VaR)</li>
<li><span class="math inline">\(p_0\)</span> = prob(violation today | no violation yesterday)</li>
<li><span class="math inline">\(p_1\)</span> = prob(violation today | violation yesterday)</li>
<li><span class="math inline">\(n_{ij}\)</span> = count of transitions from state i to j
<ul>
<li>State 0 = no violation</li>
<li>State 1 = violation</li>
</ul></li>
</ul>
<p>Where <span class="math inline">\(n_{ij}\)</span> = transitions from state <span class="math inline">\(i\)</span> to state <span class="math inline">\(j\)</span></p>
<p><strong>Why Independence Matters:</strong></p>
<ul>
<li>Violations should be randomly distributed</li>
<li>Clustering indicates model misses volatility dynamics</li>
<li>Common in models without time-varying volatility</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Example: Violation Clustering">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example: Violation Clustering
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Pattern A: Violations on days 50, 100, 150, 200</li>
<li>Pattern B: Violations on days 98, 99, 100, 101</li>
</ul>
<p>Both have 4 violations, but Pattern B shows dangerous clustering!</p>
</div>
</div>
</section>
</section>
<section id="the-basel-traffic-light-system" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="the-basel-traffic-light-system"><span class="header-section-number">4.3.2</span> The Basel Traffic Light System</h3>
<p>The Basel Committee created a framework that translates VaR backtesting results into regulatory capital requirements. Banks must calculate capital using:</p>
<p><span class="math display">\[\text{Market Risk Capital} = k \times \text{VaR}\]</span></p>
<p>Where <span class="math inline">\(k\)</span> is a multiplier (minimum 3) that increases with backtesting violations.</p>
<p><strong>How It Works:</strong></p>
<p>Banks backtest their 99% VaR over 250 trading days (1 year). With 99% confidence:</p>
<ul>
<li>Expected violations = 250 × 1% = 2.5</li>
<li>Actual violations determine the multiplier <span class="math inline">\(k\)</span></li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 25%">
<col style="width: 15%">
<col style="width: 17%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Zone</th>
<th style="text-align: center;">Violations (out of 250)</th>
<th style="text-align: center;">Multiplier <span class="math inline">\(k\)</span></th>
<th style="text-align: center;">Action</th>
<th style="text-align: center;">Probability if Model Correct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Green</strong></td>
<td style="text-align: center;">0-4</td>
<td style="text-align: center;">3.0</td>
<td style="text-align: center;">Model acceptable</td>
<td style="text-align: center;">89.2%</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Yellow</strong></td>
<td style="text-align: center;">5-9</td>
<td style="text-align: center;">3.0-4.0</td>
<td style="text-align: center;">Investigate</td>
<td style="text-align: center;">10.7%</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Red</strong></td>
<td style="text-align: center;">10+</td>
<td style="text-align: center;">4.0</td>
<td style="text-align: center;">Model inadequate</td>
<td style="text-align: center;">0.1%</td>
</tr>
</tbody>
</table>
<p>Basel requires banks to <strong>explain yellow zone violations</strong>:</p>
<ol type="1">
<li><strong>Model Problems:</strong> Incorrect implementation, missing risk factors</li>
<li><strong>Position Issues:</strong> Intraday trading not captured, wrong positions</li>
<li><strong>Market Issues:</strong> Exceptional moves, correlation breakdowns</li>
<li><strong>Bad Luck:</strong> Statistically possible even with correct model</li>
</ol>
<p><strong>Critical Weaknesses:</strong></p>
<ol type="1">
<li><strong>Low Statistical Power:</strong> With only 2.5 expected violations per year, distinguishing good from bad models is difficult</li>
<li><strong>Gaming Incentive:</strong> Banks may use conservative models to stay green rather than accurate models</li>
<li><strong>Procyclicality:</strong> Penalties increase capital requirements when losses occur (when capital is scarce)</li>
</ol>
<p><strong>Practical Reality:</strong></p>
<ul>
<li>Most banks target 3-4 violations to stay safely green</li>
<li>Models are often deliberately conservative (overstate risk)</li>
<li>True 99% accuracy is sacrificed for regulatory safety</li>
</ul>
</section>
<section id="backtesting-expected-shortfall" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="backtesting-expected-shortfall"><span class="header-section-number">4.3.3</span> Backtesting Expected Shortfall</h3>
<p>ES presents unique backtesting challenges because it’s about average tail losses, not just frequency. You can’t simply count violations - you need to assess their magnitude.</p>
<p><strong>Why ES Backtesting is Harder:</strong></p>
<ul>
<li>No single threshold to check</li>
<li>Requires modeling entire tail</li>
<li>More sensitive to extreme outliers</li>
<li>Lower statistical power</li>
</ul>
<section id="acerbi-székely-test-2014" class="level4">
<h4 class="anchored" data-anchor-id="acerbi-székely-test-2014">Acerbi-Székely Test (2014)</h4>
<p>First rigorous ES backtest that checks if average losses in the tail match ES predictions:</p>
<p><span class="math display">\[Z_{ES} = \frac{1}{n \cdot ES_\alpha} \sum_{t: L_t &gt; VaR_t} L_t - (1-\alpha)\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(Z_{ES}\)</span> = Test statistic (should be <span class="math inline">\(\approx\)</span> 0 if ES is correct)</li>
<li><span class="math inline">\(n\)</span> = Number of violations (days when loss &gt; VaR)</li>
<li><span class="math inline">\(ES_\alpha\)</span> = Expected Shortfall prediction</li>
<li><span class="math inline">\(L_t\)</span> = Actual loss on day <span class="math inline">\(t\)</span> (positive value)</li>
<li><span class="math inline">\(VaR_t\)</span> = Value at Risk on day <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\((1-\alpha)\)</span> = Tail probability (e.g., 0.05 for 95% confidence)</li>
<li>Sum includes only days where losses exceeded VaR</li>
</ul>
<p><strong>Intuition:</strong> If ES is correct, the average loss when VaR is breached should equal ES.</p>
</section>
<section id="practical-approaches" class="level4">
<h4 class="anchored" data-anchor-id="practical-approaches">Practical Approaches</h4>
<ol type="1">
<li><p><strong>Joint VaR-ES Testing:</strong></p>
<ul>
<li>First verify VaR has correct number of violations</li>
<li>Then check if violation magnitudes match ES</li>
<li>If VaR is wrong, ES is likely wrong too</li>
</ul></li>
<li><p><strong>Exceedance Residuals Method:</strong></p></li>
</ol>
<p>When loss exceeds VaR, calculate: <span class="math display">\[e_t = \frac{L_t - \text{VaR}_t}{\text{ES}_t - \text{VaR}_t}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(e_t\)</span> = Exceedance residual for day <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(L_t\)</span> = Actual loss (when &gt; VaR)</li>
</ul>
<p><strong>Key insight:</strong> Average of <span class="math inline">\(e_t\)</span> should equal 1.0 if ES is correctly calibrated.</p>
</section>
<section id="connection-between-mentioned-methods" class="level4">
<h4 class="anchored" data-anchor-id="connection-between-mentioned-methods">Connection Between Mentioned Methods</h4>
<p>Note that both detect the same problem (underestimation) but express it differently:</p>
<ul>
<li>Acerbi: Absolute deviation from expected tail behavior</li>
<li>Residuals: Relative scaling of excess losses</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="ES Backtesting">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ES Backtesting
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Given:</strong> VaR = $6M, ES = $10M, α = 0.95</li>
<li><strong>Violations:</strong> $8M, $12M, $14M (3 violations out of 250 days)</li>
</ul>
<p><strong>Acerbi-Székely Test:</strong></p>
<p><span class="math display">\[Z_{ES} = \frac{1}{3 \times 10} \times (8 + 12 + 14) - (1-0.95) = 1.083\]</span></p>
<ul>
<li>Result: Z = 1.083 (should be 0 if ES correct)</li>
<li>Interpretation: Actual average tail loss is higher than ES predicts</li>
</ul>
<p><strong>Exceedance Residuals Method:</strong></p>
<p><span class="math display">\[e_1 = \frac{8 - 6}{10 - 6} = 0.50\]</span> <span class="math display">\[e_2 = \frac{12 - 6}{10 - 6} = 1.50\]</span> <span class="math display">\[e_3 = \frac{14 - 6}{10 - 6} = 2.00\]</span> <span class="math display">\[\bar{e} = \frac{0.50 + 1.50 + 2.00}{3} = 1.33\]</span></p>
<ul>
<li>Result: Average = 1.33 (should be 1.0 if ES correct)</li>
<li>Interpretation: Excess losses are 33% higher than ES-VaR gap predicts</li>
</ul>
</div>
</div>
</section>
<section id="model-selection-and-validation" class="level4">
<h4 class="anchored" data-anchor-id="model-selection-and-validation">Model Selection and Validation</h4>
<p>Beyond formal backtesting, practitioners check for these <strong>red flags</strong>:</p>
<ul>
<li><strong>Violation clustering:</strong> Failures bunch together (model misses volatility dynamics)</li>
<li><strong>Month-end spikes:</strong> Violations around reporting dates (possible manipulation)</li>
<li><strong>Parameter instability:</strong> Small changes → big differences (overfitted model)</li>
<li><strong>Unexplained losses:</strong> Can’t explain big losses after they happen (missing risk factors)</li>
</ul>
<p><strong>Model Comparison in Practice:</strong></p>
<p>Banks typically run 2-3 models in parallel and compare:</p>
<ul>
<li>Accuracy (fewest violations)</li>
<li>Stability (consistent results)</li>
<li>Speed (computational efficiency)</li>
</ul>
<p>Most use simple models for daily reporting and complex models for capital calculations.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Key Insight:</strong> The best model isn’t always the most sophisticated - it’s the one that reliably captures your actual risks and can be explained to management.</p>
</div>
</div>
</section>
</section>
<section id="key-takeaways-2" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="key-takeaways-2"><span class="header-section-number">4.3.4</span> Key Takeaways</h3>
<p><strong>Backtesting Summary:</strong></p>
<ul>
<li><strong>Statistical rigor required:</strong> Not just counting violations</li>
<li><strong>Independence matters:</strong> Clustering reveals model deficiencies</li>
<li><strong>Basel framework:</strong> Practical but statistically weak</li>
<li><strong>ES challenges:</strong> Harder to backtest but necessary</li>
<li><strong>Holistic validation:</strong> Multiple criteria beyond backtesting</li>
</ul>
<p><strong>Best Practices:</strong></p>
<ol type="1">
<li>Test at multiple confidence levels (not just 99%)</li>
<li>Check for violation clustering</li>
<li>Analyze magnitude of exceptions</li>
<li>Run parallel models for comparison</li>
<li>Document all exceptions thoroughly</li>
<li>Regular model review cycle</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>The Ultimate Test:</strong> “Can you explain to senior management why the model failed when it did?”</p>
<p>If not, the model needs work.</p>
</div>
</div>
</section>
</section>
<section id="references" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="references"><span class="header-section-number">4.4</span> References</h2>
<div id="refs" role="list" style="display: none">

</div>
</section>
<section id="practice-questions-and-problems" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="practice-questions-and-problems"><span class="header-section-number">4.5</span> Practice Questions and Problems</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./week_03.html" class="pagination-link" aria-label="Understanding VaR and ES">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Understanding VaR and ES</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./week_05.html" class="pagination-link" aria-label="Model Risk and Implementation Reality">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Model Risk and Implementation Reality</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>