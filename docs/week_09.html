<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; Credit Risk – Risk Management and Financial Institutions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./week_10.html" rel="next">
<link href="./week_08.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week_09.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Credit Risk</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Risk Management and Financial Institutions</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to Risk Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Revision of Basic Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Market Risk I: Value at Risk</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Risk II: Expected Shortfall</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Market Risk III: Model Validation and Regulatory Capital</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Test 1: Market Risk Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Reading Week</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Liquidity Risk</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_09.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Credit Risk</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Operational Risk</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Bank Regulation, FRTB, and Economic Capital</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Test 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week_13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Final Exam</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#block-a-understanding-credit-risk-components" id="toc-block-a-understanding-credit-risk-components" class="nav-link active" data-scroll-target="#block-a-understanding-credit-risk-components">Block A: Understanding Credit Risk Components</a>
  <ul class="collapse">
  <li><a href="#theory-the-three-component-framework" id="toc-theory-the-three-component-framework" class="nav-link" data-scroll-target="#theory-the-three-component-framework">Theory: The Three-Component Framework</a></li>
  <li><a href="#activity-1-loan-portfolio-analysis" id="toc-activity-1-loan-portfolio-analysis" class="nav-link" data-scroll-target="#activity-1-loan-portfolio-analysis">Activity 1: Loan Portfolio Analysis</a></li>
  <li><a href="#key-insights-el-vs.-ul-and-banking-economics" id="toc-key-insights-el-vs.-ul-and-banking-economics" class="nav-link" data-scroll-target="#key-insights-el-vs.-ul-and-banking-economics">Key Insights: EL vs.&nbsp;UL and Banking Economics</a></li>
  </ul></li>
  <li><a href="#block-b-credit-migration-and-mark-to-market" id="toc-block-b-credit-migration-and-mark-to-market" class="nav-link" data-scroll-target="#block-b-credit-migration-and-mark-to-market">Block B: Credit Migration and Mark-to-Market</a>
  <ul class="collapse">
  <li><a href="#theory-credit-risk-beyond-default" id="toc-theory-credit-risk-beyond-default" class="nav-link" data-scroll-target="#theory-credit-risk-beyond-default">Theory: Credit Risk Beyond Default</a></li>
  <li><a href="#activity-2-bond-portfolio-revaluation" id="toc-activity-2-bond-portfolio-revaluation" class="nav-link" data-scroll-target="#activity-2-bond-portfolio-revaluation">Activity 2: Bond Portfolio Revaluation</a></li>
  <li><a href="#key-insights-migration-risk-and-portfolio-management" id="toc-key-insights-migration-risk-and-portfolio-management" class="nav-link" data-scroll-target="#key-insights-migration-risk-and-portfolio-management">Key Insights: Migration Risk and Portfolio Management</a></li>
  </ul></li>
  <li><a href="#block-c-historical-default-probabilities" id="toc-block-c-historical-default-probabilities" class="nav-link" data-scroll-target="#block-c-historical-default-probabilities">Block C: Historical Default Probabilities</a>
  <ul class="collapse">
  <li><a href="#theory-measuring-default-probability" id="toc-theory-measuring-default-probability" class="nav-link" data-scroll-target="#theory-measuring-default-probability">Theory: Measuring Default Probability</a></li>
  <li><a href="#activity-3-historical-default-probability-analysis" id="toc-activity-3-historical-default-probability-analysis" class="nav-link" data-scroll-target="#activity-3-historical-default-probability-analysis">Activity 3: Historical Default Probability Analysis</a></li>
  <li><a href="#key-insights-default-probability-measures-and-transition-matrices" id="toc-key-insights-default-probability-measures-and-transition-matrices" class="nav-link" data-scroll-target="#key-insights-default-probability-measures-and-transition-matrices">Key Insights: Default Probability Measures and Transition Matrices</a></li>
  </ul></li>
  <li><a href="#block-d-market-implied-default-probabilities" id="toc-block-d-market-implied-default-probabilities" class="nav-link" data-scroll-target="#block-d-market-implied-default-probabilities">Block D: Market-Implied Default Probabilities</a>
  <ul class="collapse">
  <li><a href="#theory-from-cds-spreads-to-default-probabilities" id="toc-theory-from-cds-spreads-to-default-probabilities" class="nav-link" data-scroll-target="#theory-from-cds-spreads-to-default-probabilities">Theory: From CDS Spreads to Default Probabilities</a></li>
  <li><a href="#activity-4-extracting-market-implied-probabilities" id="toc-activity-4-extracting-market-implied-probabilities" class="nav-link" data-scroll-target="#activity-4-extracting-market-implied-probabilities">Activity 4: Extracting Market-Implied Probabilities</a></li>
  <li><a href="#key-insights-market-implied-probabilities-and-the-risk-premium" id="toc-key-insights-market-implied-probabilities-and-the-risk-premium" class="nav-link" data-scroll-target="#key-insights-market-implied-probabilities-and-the-risk-premium">Key Insights: Market-Implied Probabilities and the Risk Premium</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Credit Risk</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled" title="References">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
References
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Hull, J. C. 2023. Risk Management and Financial Institutions. Wiley Finance.
<ul>
<li>Chapter 17 - Estimating Default Probabilities</li>
<li>Chapter 18 - xVAs</li>
<li>Chapter 19 - Credit Value at Risk</li>
</ul></li>
</ul>
</div>
</div>
<p><strong>Learning Outcomes:</strong></p>
<ul>
<li>Calculate expected loss (PD × LGD × EAD) and distinguish between expected and unexpected loss for capital management</li>
<li>Analyze credit migration risk: calculate mark-to-market losses from rating downgrades and identify fallen angel effects</li>
<li>Measure default probabilities using cumulative, marginal, and hazard rate approaches, and interpolate to any maturity</li>
<li>Extract market-implied default probabilities from CDS spreads and explain why they exceed historical rates</li>
<li>Connect credit risk to liquidity risk through fallen angel HQLA disqualification and wrong-way risk</li>
</ul>
<section id="block-a-understanding-credit-risk-components" class="level2">
<h2 class="anchored" data-anchor-id="block-a-understanding-credit-risk-components">Block A: Understanding Credit Risk Components</h2>
<section id="theory-the-three-component-framework" class="level3">
<h3 class="anchored" data-anchor-id="theory-the-three-component-framework">Theory: The Three-Component Framework</h3>
<p>Credit risk differs fundamentally from market risk. While market risk involves continuous, observable price movements that are relatively symmetric, credit risk is <strong>asymmetric</strong> (limited upside vs.&nbsp;potential total loss), <strong>discrete</strong> (default or no default), and <strong>latent</strong> (deterioration invisible until default).</p>
<p>To quantify credit risk, we decompose every exposure into three multiplicative components:</p>
<ul>
<li><strong>Probability of Default (PD):</strong> Likelihood of borrower failure within one year (estimated from historical rates, credit ratings, or internal models).</li>
<li><strong>Loss Given Default (LGD):</strong> Percentage lost if default occurs (depends on collateral quality and seniority). <span class="math display">\[
\text{LGD} = 1 - \text{Recovery Rate}
\]</span></li>
<li><strong>Exposure at Default (EAD):</strong> Dollar amount at risk when default occurs. For credit lines: <span class="math display">\[
\text{EAD} = \text{Current Exposure} + (\text{Undrawn} \times \text{CCF})
\]</span> where CCF (Credit Conversion Factor) captures borrower drawdown behavior before default.</li>
</ul>
<p>These combine multiplicatively to produce <strong>Expected Loss</strong>:</p>
<p><span class="math display">\[
\text{EL} = \text{PD} \times \text{LGD} \times \text{EAD}
\]</span></p>
<p>Expected loss (EL) is the <strong>mean</strong> of the loss distribution—predictable and priced into loan spreads. <strong>Unexpected loss</strong> (UL) is the <strong>volatility</strong> around that mean—the true risk requiring capital protection. This separation drives banking economics: spreads must cover EL, while capital absorbs UL.</p>
<p>Connection to Week 8: Credit downgrades create wrong-way risk for liquidity—collateral backing funding facilities loses value precisely when funding stress peaks.</p>
</section>
<section id="activity-1-loan-portfolio-analysis" class="level3">
<h3 class="anchored" data-anchor-id="activity-1-loan-portfolio-analysis">Activity 1: Loan Portfolio Analysis</h3>
<p>You are a loan officer at Regional Bank evaluating a portfolio of 10 loans. Calculate expected loss for each loan using the three-component framework.</p>
<p><a href="data/Credit_Risk_Data.xlsx" download="" class="btn btn-primary"> <i class="bi bi-download"></i> Download Credit Risk Data </a></p>
<p>Use the <strong>Loan_Portfolio</strong> sheet from the Excel file.</p>
<p><strong>Task 1.1: Calculate PD, LGD, and EAD</strong></p>
<p>For each of the 10 loans, calculate:</p>
<ul>
<li><strong>PD:</strong> Use the Historical_Default_Rate_Pct column</li>
<li><strong>LGD:</strong> Calculate as <span class="math inline">\(\max(0, \frac{\text{Exposure} - \text{Collateral Value}}{\text{Exposure}})\)</span> (assumes collateral recovers at stated value; in practice, banks apply haircuts and workout costs)</li>
<li><strong>EAD:</strong> Apply the formula above with CCF = 50% (the Basel III standard for committed credit lines)</li>
</ul>
<p>Then analyze patterns:</p>
<ul>
<li>Which borrower type has the highest average PD? Why might BB-rated Corporate (L002) and BB-rated SME (L006) have different PDs despite identical ratings?</li>
<li>Compare LGD for residential mortgages L007 vs.&nbsp;L009. What drives the difference? What happens when collateral exceeds exposure?</li>
<li>Which loans have EAD &gt; Current Exposure, and why does this matter for risk management?</li>
</ul>
<p><strong>Task 1.2: Calculate Expected Loss</strong></p>
<p>Combine the three components: EL = PD × LGD × EAD. Calculate both dollar EL and EL as % of EAD.</p>
<ul>
<li>Which loan has the highest dollar EL? Highest EL percentage? What drives these differences?</li>
<li>Compare L001 (BBB Corporate, Equipment) vs.&nbsp;L010 (AAA Corporate, Government bonds). Which has higher EL and why?</li>
<li>If you could only monitor 3 loans intensively, which would you choose based on EL and component analysis?</li>
</ul>
</section>
<section id="key-insights-el-vs.-ul-and-banking-economics" class="level3">
<h3 class="anchored" data-anchor-id="key-insights-el-vs.-ul-and-banking-economics">Key Insights: EL vs.&nbsp;UL and Banking Economics</h3>
<p><strong>Expected Loss (EL):</strong> The predictable mean loss that should be covered by loan pricing (interest rate spreads) and provisions. If mispriced, banks lose money systematically even without defaults.</p>
<p><strong>Unexpected Loss (UL):</strong> The volatility around EL (standard deviation) representing true credit risk. Covered by bank capital (equity). For regulatory purposes:</p>
<p><span class="math display">\[
\text{Credit VaR}_{99.9\%} = \text{EL} + z_{99.9\%} \times \text{UL}
\]</span></p>
<p><strong>Recovery rates</strong> vary significantly by collateral type. Industry benchmarks: government bonds (95%), residential property (70%), equipment (50%), unsecured (10%). Banks apply haircuts to collateral values and add workout costs when estimating regulatory LGD.</p>
<p><strong>Risk management implications:</strong> The multiplicative formula allows component substitution—improve any component to reduce EL. Different mitigation strategies target different components: stricter underwriting (lower PD), collateral requirements (lower LGD), exposure limits (lower EAD).</p>
<p>This framework supports Basel III capital requirements (covered in later blocks): regulatory capital must cover unexpected losses at 99.9% confidence, while provisions cover expected losses. The separation between pricing (EL) and capital (UL) is fundamental to banking profitability.</p>
</section>
</section>
<section id="block-b-credit-migration-and-mark-to-market" class="level2">
<h2 class="anchored" data-anchor-id="block-b-credit-migration-and-mark-to-market">Block B: Credit Migration and Mark-to-Market</h2>
<section id="theory-credit-risk-beyond-default" class="level3">
<h3 class="anchored" data-anchor-id="theory-credit-risk-beyond-default">Theory: Credit Risk Beyond Default</h3>
<p>Block A focused on default risk—borrowers failing to repay. But <strong>credit risk is not binary</strong>. You can lose money even without defaults occurring, whenever credit quality deteriorates.</p>
<p><strong>Three Sources of Credit Losses:</strong></p>
<ul>
<li><strong>Default Risk:</strong> Borrower fails to repay (binary event, covered in Block A)</li>
<li><strong>Migration Risk:</strong> Credit rating downgrades reduce bond values through spread widening</li>
<li><strong>Spread Risk:</strong> Market-wide credit spread movements independent of specific rating changes</li>
</ul>
<p><strong>Why Migration Matters:</strong> For <strong>trading books</strong> (mark-to-market accounting), migration and spread risk dominate daily P&amp;L. For <strong>banking books</strong> (held-to-maturity accounting), only default matters if bonds are held to maturity without impairment.</p>
<p><strong>The Bond Pricing Mechanism:</strong> When credit quality deteriorates and rating agencies downgrade bonds, market participants demand higher yields to compensate for increased risk:</p>
<p><span class="math display">\[
\text{Bond Yield} = \text{Risk-Free Rate} + \text{Credit Spread}
\]</span></p>
<p>As spreads widen, bond prices must fall to bring yields up to market levels:</p>
<p><span class="math display">\[
\Delta \text{Price} \% \approx -\text{Modified Duration} \times \Delta \text{Spread}
\]</span></p>
<p><strong>The Fallen Angel Effect:</strong> When bonds cross from investment grade (BBB- or better) to high yield (BB+ or worse), they trigger institutional forced selling (pension funds, insurance mandates cannot hold high-yield bonds), HQLA disqualification for LCR (Week 8 connection), and liquidity evaporation—creating losses beyond normal spread widening.</p>
</section>
<section id="activity-2-bond-portfolio-revaluation" class="level3">
<h3 class="anchored" data-anchor-id="activity-2-bond-portfolio-revaluation">Activity 2: Bond Portfolio Revaluation</h3>
<p>You are a fixed income portfolio manager at Investment Fund. This quarter, rating agencies announced downgrades for several bonds in your portfolio. Assess the mark-to-market impact.</p>
<p>Use the <strong>Bond_Portfolio</strong> sheet from the data file.</p>
<p><strong>Task 2.1: Calculate Mark-to-Market Losses</strong></p>
<p>For each bond with a rating change:</p>
<ul>
<li>Calculate the new bond yield using the updated credit spread (from Credit_Spreads table based on new rating and maturity)</li>
<li>Price the bond using: <code>=-PV(new_yield, maturity, coupon, 100)</code> in Excel (assumes annual coupons)</li>
<li>Calculate the mark-to-market loss in dollars</li>
</ul>
<p>Then analyze:</p>
<ul>
<li>Which bond experiences the largest dollar loss from rating migration?</li>
<li>Compare percentage losses: are longer-maturity or shorter-maturity bonds more affected by identical rating downgrades? Why does this pattern emerge?</li>
</ul>
<p><strong>Task 2.2: Fallen Angels and Liquidity Impact</strong></p>
<ul>
<li>Which bond(s) crossed from investment grade (BBB- or better) to high yield (BB+ or worse)?</li>
<li>Why is this transition especially problematic? What institutional consequences does it trigger?</li>
<li>If you hold the fallen angel to maturity without default, will you recover the MTM loss?</li>
<li>Which accounting regime makes rating downgrades more painful: trading books or banking books?</li>
<li>Before the downgrade, the fallen angel qualified for your LCR at 85% value. What happens after it becomes high yield?</li>
<li>Explain the wrong-way risk: why do credit downgrades create maximum problems during stress periods?</li>
</ul>
</section>
<section id="key-insights-migration-risk-and-portfolio-management" class="level3">
<h3 class="anchored" data-anchor-id="key-insights-migration-risk-and-portfolio-management">Key Insights: Migration Risk and Portfolio Management</h3>
<p><strong>Trading vs.&nbsp;Banking Books:</strong> Trading books mark-to-market daily, so rating migrations create immediate P&amp;L losses and capital charges. Banking books use amortized cost—if held to maturity without default, MTM losses don’t materialize. However, banks must recognize impairment if credit deterioration becomes permanent under IFRS 9/CECL.</p>
<p><strong>Duration Amplifies Credit Risk:</strong> Longer-duration bonds suffer larger losses from identical spread widening. A 10-year bond (duration ≈ 7.5) loses ~7.5% when spreads widen 100 bps, while a 2-year bond (duration ≈ 1.9) loses only ~1.9%. This explains why duration management is crucial for credit portfolios.</p>
<p><strong>Wrong-Way Risk (Week 8 Callback):</strong> Credit downgrades trigger wrong-way risk—collateral backing funding facilities loses value precisely when liquidity is needed most. Fallen angels lose HQLA eligibility entirely, forcing fire sales during stress periods and creating liquidity doom loops.</p>
</section>
</section>
<section id="block-c-historical-default-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="block-c-historical-default-probabilities">Block C: Historical Default Probabilities</h2>
<section id="theory-measuring-default-probability" class="level3">
<h3 class="anchored" data-anchor-id="theory-measuring-default-probability">Theory: Measuring Default Probability</h3>
<p>When analyzing credit risk, we use three interconnected measures that provide equivalent information from different perspectives:</p>
<p><strong>1. Cumulative (Unconditional) Default Probability - <span class="math inline">\(Q(t)\)</span></strong></p>
<ul>
<li>Probability of default within <span class="math inline">\([0,t]\)</span>.</li>
<li>“What’s the chance they default sometime in the next <span class="math inline">\(t\)</span> years?”</li>
<li>Always increases with time.</li>
<li>Example: <span class="math inline">\(Q(5) = 1.54\%\)</span> means 1.54% of BBB companies default within 5 years.</li>
</ul>
<p><strong>2. Marginal (Conditional) Default Probability - <span class="math inline">\(q(t)\)</span></strong></p>
<ul>
<li>Probability of default in period <span class="math inline">\(t\)</span>, given survival through <span class="math inline">\(t-1\)</span>.</li>
<li>“If they survived this long, what’s the chance they default next period?”</li>
<li>Can increase or decrease over time.</li>
<li>Formula: <span class="math display">\[q(t) = \frac{Q(t) - Q(t-1)}{1 - Q(t-1)}\]</span></li>
</ul>
<p><strong>3. Hazard Rate - <span class="math inline">\(h(t)\)</span></strong></p>
<ul>
<li>Instantaneous default intensity (continuous-time version of marginal PD).</li>
<li>Used to interpolate default probabilities to any maturity.</li>
<li>For constant hazard rate: <span class="math display">\[Q(t) = 1 - e^{-h \cdot t}\]</span> <span class="math display">\[h = -\frac{1}{t} \ln(1 - Q(t))\]</span></li>
</ul>
<p>Additionally, <strong>Credit Rating Transition Matrices</strong> show one-year probabilities of rating changes, capturing both defaults (in the default column) and migrations (downgrades/upgrades) simultaneously.</p>
</section>
<section id="activity-3-historical-default-probability-analysis" class="level3">
<h3 class="anchored" data-anchor-id="activity-3-historical-default-probability-analysis">Activity 3: Historical Default Probability Analysis</h3>
<p>Use the <strong>Default_Probs</strong> sheet from the data file. It contains actual default data from rating agencies (1981-2020).</p>
<p><strong>Task 3.1: Interpreting and Calculating Default Probabilities</strong></p>
<ul>
<li>What percentage of BBB companies default within 5 years? How many defaults would you expect from 100 B-rated bonds held for 2 years?</li>
<li>Calculate marginal default probabilities for BBB-rated companies for years 2 and 5.</li>
<li>Compare marginal PDs for year 5: Calculate for both AA and B ratings. What pattern emerges as credit quality deteriorates?</li>
</ul>
<p><strong>Task 3.2: Hazard Rates and Non-Integer Maturities</strong></p>
<p>Banks need default probabilities for any time horizon, not just whole years.</p>
<ul>
<li>Calculate the constant hazard rate for AA companies using the 5-year cumulative PD.</li>
<li>Using this hazard rate, calculate cumulative default probabilities for 2.5-year and 7-year maturities.</li>
<li>Repeat for BB-rated companies. How do the hazard rates compare across credit quality?</li>
</ul>
</section>
<section id="key-insights-default-probability-measures-and-transition-matrices" class="level3">
<h3 class="anchored" data-anchor-id="key-insights-default-probability-measures-and-transition-matrices">Key Insights: Default Probability Measures and Transition Matrices</h3>
<p><strong>The Three Measures Are Mathematically Equivalent:</strong> Cumulative PD, marginal PD, and hazard rates contain the same information viewed differently. Banks choose based on use case: cumulative PD for total exposure risk, marginal PD for time-varying risk patterns, hazard rates for pricing and interpolation.</p>
<p><strong>Hazard Rates Enable Flexibility:</strong> The constant hazard rate assumption allows banks to extract default probabilities for ANY maturity from limited historical data. While real hazard rates aren’t perfectly constant, this approximation works well for most credit applications.</p>
<p><strong>Rating-Specific Patterns:</strong> Investment-grade ratings (AAA-BBB) show low, gradually increasing marginal PDs. High-yield ratings (BB-B) show high initial marginal PDs that may decline over time (survivors become stronger). CCC/C ratings have extreme first-year PDs reflecting near-term distress.</p>
<p><strong>Credit Rating Transition Matrix Applications:</strong> The transition matrix provides one-year migration probabilities AND one-year default probabilities simultaneously. Diagonal values show rating stability. Banks use this for: portfolio loss estimation from defaults AND downgrades, regulatory stress testing, fallen angel probability (BBB → BB transition), and MTM loss calculations.</p>
</section>
</section>
<section id="block-d-market-implied-default-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="block-d-market-implied-default-probabilities">Block D: Market-Implied Default Probabilities</h2>
<section id="theory-from-cds-spreads-to-default-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="theory-from-cds-spreads-to-default-probabilities">Theory: From CDS Spreads to Default Probabilities</h3>
<p>Block C showed historical default probabilities from past data (1981-2020). But markets are forward-looking: <strong>CDS spreads</strong> tell us what investors expect going forward and what they charge for default protection today.</p>
<p><strong>Credit Default Swaps (CDS):</strong> Insurance contracts against default. The buyer pays an annual premium (the CDS spread, in basis points) to transfer default risk to the seller. Higher expected default probability → higher CDS spread.</p>
<p><strong>Risk-Neutral vs.&nbsp;Historical Probabilities:</strong></p>
<ul>
<li><strong>Historical (Real-World) PD:</strong> Actual default frequencies from rating agency data (Block C)</li>
<li><strong>Risk-Neutral (Market-Implied) PD:</strong> Default probabilities extracted from CDS market prices</li>
<li><strong>Why they differ:</strong> Risk-neutral PDs systematically exceed historical PDs because markets price in risk premiums—investors demand extra compensation beyond expected loss for bearing default risk</li>
</ul>
<p><strong>Extracting Default Probabilities from CDS Spreads:</strong></p>
<p>Using Block C’s constant hazard rate framework applied to market prices: Given CDS spread <span class="math inline">\(s\)</span> (as decimal) and recovery rate <span class="math inline">\(R\)</span>, the implied hazard rate is:</p>
<p><span class="math display">\[h = \frac{s}{1 - R}\]</span></p>
<p>The risk-neutral cumulative default probability over <span class="math inline">\(t\)</span> years is:</p>
<p><span class="math display">\[Q^{RN}(t) = 1 - e^{-h \cdot t} = 1 - e^{-\frac{s \cdot t}{1-R}}\]</span></p>
<p>Example: Ford CDS spread = 180 bps = 0.0180, recovery = 40%, so <span class="math display">\[h = 0.0180/0.60 = 0.03\]</span> <span class="math display">\[Q^{RN}(5) = 1 - e^{-0.03 \times 5} = 13.9\%\]</span></p>
</section>
<section id="activity-4-extracting-market-implied-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="activity-4-extracting-market-implied-probabilities">Activity 4: Extracting Market-Implied Probabilities</h3>
<p><strong>Current 5-Year CDS Spreads (basis points):</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Company</th>
<th style="text-align: center;">Rating</th>
<th style="text-align: center;">CDS Spread</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Apple</td>
<td style="text-align: center;">AA</td>
<td style="text-align: center;">35 bps</td>
</tr>
<tr class="even">
<td style="text-align: center;">IBM</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">65 bps</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Ford</td>
<td style="text-align: center;">BBB</td>
<td style="text-align: center;">180 bps</td>
</tr>
<tr class="even">
<td style="text-align: center;">Tesla</td>
<td style="text-align: center;">BB</td>
<td style="text-align: center;">420 bps</td>
</tr>
<tr class="odd">
<td style="text-align: center;">AMC</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">850 bps</td>
</tr>
</tbody>
</table>
<p>Assume 40% recovery rate for all companies.</p>
<p><strong>Task 4.1: Calculate and Compare Market-Implied vs.&nbsp;Historical Probabilities</strong></p>
<p>For IBM, Ford, and Tesla:</p>
<ul>
<li>Calculate the implied hazard rate.</li>
<li>Calculate the 5-year risk-neutral default probability.</li>
<li>Compare to historical 5-year PDs from Block C (A: 0.46%, BBB: 1.54%, BB: 6.43%)</li>
<li>What pattern emerges? Why do market-implied PDs consistently exceed historical rates?</li>
<li>Calculate the risk premium (risk-neutral PD − historical PD) for each company. Which rating shows the largest premium in percentage points?</li>
</ul>
<p><strong>Task 4.2: Bond-CDS Arbitrage Analysis</strong></p>
<p>Ford’s 5-year bond yields 5.2% while the 5-year Treasury yields 3.5%, giving a bond credit spread of 170 bps. Ford’s CDS spread is 180 bps.</p>
<ul>
<li>In theory, bond spreads and CDS spreads should converge (both price default risk). Why might they differ by 10 bps in practice?</li>
<li>If Ford’s CDS spread jumped to 250 bps while the bond spread stayed at 170 bps, what arbitrage trade could you execute?</li>
</ul>
</section>
<section id="key-insights-market-implied-probabilities-and-the-risk-premium" class="level3">
<h3 class="anchored" data-anchor-id="key-insights-market-implied-probabilities-and-the-risk-premium">Key Insights: Market-Implied Probabilities and the Risk Premium</h3>
<p><strong>Risk-Neutral &gt; Historical:</strong> Market-implied default probabilities systematically exceed historical default rates because CDS prices embed risk premiums. Investors demand compensation beyond expected loss for bearing default risk—especially for lower-rated credits where losses are concentrated and correlation risk is high. The risk premium reflects investor risk aversion and market liquidity conditions.</p>
<p><strong>Forward-Looking vs.&nbsp;Backward-Looking:</strong> Historical PDs tell us what happened over 1981-2020 across all economic cycles. CDS spreads reflect current market expectations given today’s economic conditions, credit cycle position, and investor risk appetite. During stress periods (2008, 2020), CDS spreads spike far above long-run historical averages.</p>
<p><strong>Bond-CDS Basis:</strong> In frictionless markets, bond credit spreads and CDS spreads should align (both price default risk). Deviations create arbitrage opportunities through basis trades. Persistent basis reflects funding costs, counterparty risk in CDS contracts, and cheapest-to-deliver options in bond delivery.</p>
<p><strong>Practical Applications:</strong> Banks use market-implied PDs for trading book valuation (mark-to-market), credit portfolio hedging, and counterparty credit risk (CVA calculations). Historical PDs are used for banking book provisions (IFRS 9/CECL) and stress testing. Connection to Block B: CDS spreads and bond spreads move together, both reflecting migration risk and default risk simultaneously.</p>
</section>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>Expected loss</strong> (PD × LGD × EAD) measures average credit losses, while <strong>Credit VaR</strong> captures unexpected losses that determine capital requirements</li>
<li><strong>Recovery rates</strong> vary significantly by seniority and collateral, with senior secured bonds recovering substantially more than subordinated debt</li>
<li><strong>Credit migration risk</strong> creates mark-to-market losses even without default, as rating downgrades widen spreads and reduce bond values</li>
<li><strong>Default probabilities</strong> can be measured three ways (cumulative, marginal, hazard rate) and allow calculation of default risk for any time horizon</li>
<li><strong>Historical default rates</strong> increase sharply with lower credit ratings, demonstrating the nonlinear relationship between rating quality and default risk</li>
<li><strong>Market-implied probabilities</strong> from CDS spreads exceed historical default rates because they include risk premiums and reflect forward-looking investor expectations</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./week_08.html" class="pagination-link" aria-label="Liquidity Risk">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Liquidity Risk</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./week_10.html" class="pagination-link" aria-label="Operational Risk">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Operational Risk</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>